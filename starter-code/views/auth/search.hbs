<h2>Map</h2>


<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.0/mapbox-gl-geocoder.min.js'></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v3.1.0/mapbox-gl-geocoder.css' type='text/css' />
  

<style>
  body {
    margin: 0;
    padding: 0;
  }
  #map {
    position: absolute;
    top: 150px;
    bottom: 0;
    width: 100%;
  }
</style>

<div id='map'></div>


<script>
  console.log('holi')
  var promise = new Promise(function (resolve, reject) {
    navigator.geolocation.getCurrentPosition(function (position) {
      console.log('obtenidas posiciones', position.coords.latitude)
      resolve(pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      })
    })
  });

  promise.then(currentCoords => {
    console.log(currentCoords)
    mapboxgl.accessToken = 'pk.eyJ1IjoidmljYmFuIiwiYSI6ImNqczFobXl5cTFsbXI0M29jdXp6OXVqcGQifQ.YPIeCxviK0RvnP3aUa3qgg';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [currentCoords.lng, currentCoords.lat],
      zoom: 13
    });

    map.addControl(new mapboxgl.GeolocateControl({
positionOptions: {
enableHighAccuracy: true
},
trackUserLocation: true
}));

    var geojson = {
      type: 'FeatureCollection',
      features: [{
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [currentCoords.lng, currentCoords.lat]
        },
      },
      ]
    }
    new mapboxgl.Marker()
      .setLngLat(geojson.features[0].geometry.coordinates)
      .addTo(map);

    var geocoder = map.addControl(new MapboxGeocoder({
      accessToken: mapboxgl.accessToken
    }));

    axios.get("http://localhost:3000/auth/search/bands")
      .then(response => {
        response.data.usersArray.forEach((place, index) => {
          console.log(place)
          console.log(index)
          new mapboxgl.Marker()
            .setLngLat(place.place)
            .addTo(map);
            let userPlace = {
            type: "FeatureCollection",
            features: [
              {
                "type": "Feature",
                /*"properties": {
                  "username": place.username, 
                  "style": place.style,
                  "price": place.price 
                },*/
                "geometry": {
                  "type": "Point",
                  "coordinates": [
                    place.place.lat,
                    place.place.lng
                  ]
                }
              }]
          };
          map.on('click', function () {
          var popup = new mapboxgl.Popup({closeOnClick: false})
          .setLngLat(response.data.usersArray[index].place)
          .setHTML('<h1>Hello World!</h1>')
          .addTo(map);
        })
        
        })
        

      })
  

  });

</script>